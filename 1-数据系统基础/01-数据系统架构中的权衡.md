# 简介

随着应用程序需求变得更加复杂，将所有内容存储在一个系统中已经不够，可能需要组合多个提供不同能力的存储或处理系统。例如，许多应用程序需要：

- 存储数据，以便它们或其他应用程序以后能再次找到（**数据库**）
- 记住昂贵操作的结果，以加快读取速度（**缓存**）
- 允许用户按关键字搜索数据或以各种方式过滤数据（**搜索索引**）
- 一旦事件和数据变更发生就立即处理（**流处理**）
- 定期处理累积的大量数据（**批处理**）



有许多具有不同特性的数据库系统，适合不同的目的——你如何选择使用哪一个？有各种缓存方法、构建搜索索引的几种方式等等——你如何在它们之间进行权衡？

为了帮助你了解可以做出哪些选择，本章比较了几个对比概念，并探讨了它们的权衡：

- 事务型系统和分析型系统之间的区别；
- 云服务和自托管系统的利弊；
- 何时从单节点系统转向分布式系统；
- 平衡业务需求和用户权利。



# 分析型与事务型系统

如果你在企业中从事数据系统工作，你可能会遇到几种不同类型的数据工作者：

- 第一类是**后端工程师**，他们构建服务来处理读取和更新数据的请求。
- 第二类是**业务分析师**，他们生成关于组织活动的报告，以帮助管理层做出更好的决策（**商业智能** 或 **BI**）
- 第二类是**数据科学家**，他们在数据中寻找新的见解，或创建由数据分析和机器学习（AI）支持的面向用户的产品功能（例如推荐、风险评分或垃圾邮件过滤等预测分析，以及搜索结果排名）



尽管业务分析师和数据科学家倾向于使用不同的工具并以不同的方式操作，但他们有一些共同点：两者都执行 **分析**，这意味着他们查看用户和后端服务生成的数据，但他们通常不修改这些数据（除了可能修复错误）。他们可能创建派生数据集，其中原始数据已经以某种方式处理过。这导致了两种类型系统之间的分离：

- **事务型系统** 由后端服务和数据基础设施组成，在这里创建数据，例如通过服务外部用户。在这里，应用程序代码基于用户执行的操作读取和修改其数据库中的数据。
- **分析型系统** 服务于业务分析师和数据科学家的需求。它们包含来自事务型系统的只读数据副本，并针对分析所需的数据处理类型进行了优化。



随着这些系统的成熟，出现了两个新的专业角色：**数据工程师** 和 **分析工程师**。数据工程师是知道如何集成事务型系统和分析型系统的人，并更广泛地负责组织的数据基础设施。分析工程师对数据进行建模和转换，使其对组织中的业务分析师和数据科学家更有用。

## 事务处理与分析的特征

**事务（transaction）** 指的是形成逻辑单元的一组读取和写入。事务型系统通常通过某个键查找少量记录（这称为 **点查询**）。基于用户的输入插入、更新或删除记录。因为这些应用程序是交互式的，这种访问模式被称为 **联机事务处理**（OLTP）。

与 OLTP 相比，分析具有非常不同的访问模式。分析查询会扫描大量记录，并计算聚合统计信息（如计数、求和或平均值）。为了将这种使用数据库的模式与事务处理区分开来，它被称为 **联机分析处理**（OLAP）。

这两种系统的区别如下：

| 属性         | 事务型系统（OLTP）             | 分析型系统（OLAP）       |
| ------------ | ------------------------------ | ------------------------ |
| 主要读取模式 | 点查询（通过键获取单个记录）   | 对大量记录进行聚合       |
| 主要写入模式 | 创建、更新和删除单个记录       | 批量导入（ETL）或事件流  |
| 人类用户示例 | Web 或移动应用程序的最终用户   | 内部分析师，用于决策支持 |
| 机器使用示例 | 检查操作是否被授权             | 检测欺诈/滥用模式        |
| 查询类型     | 固定的查询集，由应用程序预定义 | 分析师可以进行任意查询   |
| 数据代表     | 数据的最新状态（当前时间点）   | 随时间发生的事件历史     |
| 数据集大小   | GB 到 TB                       | TB 到 PB                 |



在事务型系统中，通常不允许用户构建自定义 SQL 查询并在数据库上运行它们，因为这可能会允许他们读取或修改他们没有权限访问的数据。此外，他们可能编写执行成本高昂的查询，从而影响其他用户的数据库性能。出于这些原因，OLTP 系统主要运行嵌入到应用程序代码中的固定查询集，只偶尔使用一次性的自定义查询来进行维护或故障排除。

另一方面，分析数据库通常让用户可以自由地手动编写任意 SQL 查询，或使用 Tableau、Looker 或 Microsoft Power BI 等数据可视化或仪表板工具自动生成查询。



还有一种类型的系统是为分析型的需求（对许多记录进行聚合的查询）设计的，但嵌入到面向用户的产品中。这一类别被称为 **产品分析** 或 **实时分析**，为这种用途设计的系统包括 Pinot、Druid 和 ClickHouse。

## 数据仓库

在 20 世纪 80 年代末和 90 年代初，企业有停止使用其 OLTP 系统进行分析目的的趋势，转而在单独的数据库系统上运行分析。这个单独的数据库被称为**数据仓库**。

一家大型企业可能有几十个甚至上百个联机事务处理系统，这些系统中的每一个都很复杂，需要一个团队来维护它，因此这些系统最终主要是相互独立地运行。

出于几个原因，业务分析师和数据科学家直接查询这些 OLTP 系统通常是不可取的：

- 感兴趣的数据可能分布在多个事务型系统中，使得在单个查询中组合这些数据集变得困难（称为**数据孤岛**的问题）；
- 适合 OLTP 的模式和数据布局不太适合分析；
- 分析查询可能相当昂贵，在 OLTP 数据库上运行它们会影响其他用户的性能；
- 出于安全或合规原因，OLTP 系统可能位于不允许用户直接访问的单独网络中。

相比之下，**数据仓库** 是一个单独的数据库，分析师可以随心所欲地查询，而不会影响 OLTP 操作。



数据仓库包含公司中所有各种 OLTP 系统中数据的只读副本。数据从 OLTP 数据库中提取（使用定期数据转储或连续更新流），转换为分析友好的模式，进行清理，然后加载到数据仓库中。这种将数据导入数据仓库的过程称为 **提取-转换-加载**（ETL），如图 1-1所示。有时 **转换** 和 **加载** 步骤的顺序会互换（即，先加载，再在数据仓库中进行转换），从而产生 **ELT**。

![img](01-数据系统架构中的权衡.assets/ddia_0101.png)

<center style="color:#C0C0C0;text-decoration:underline">图 1-1</center>



一些数据库系统提供 **混合事务/分析处理**（HTAP），目标是在单个系统中同时支持 OLTP 和分析，而无需从一个系统 ETL 到另一个系统。然而，许多 HTAP 系统内部由一个 OLTP 系统与一个单独的分析系统耦合组成，隐藏在公共接口后面。

尽管 HTAP 存在，但由于目标和要求不同，事务型系统和分析型系统之间的分离是常见的。HTAP 不会取代数据仓库，它在同一应用程序既需要执行扫描大量行的分析查询，又需要以低延迟读取和更新单个记录的场景中很有用。例如，欺诈检测可能涉及此类工作内容。

### 从数据仓库到数据湖

数据仓库通常使用通过 SQL 进行查询的 **关系** 数据模型，可能使用专门的商业智能软件。这个模型很适合业务分析师需要进行的查询类型，但不太适合数据科学家的需求，他们可能需要执行以下任务：

- 将数据转换为适合训练机器学习模型的形式；这通常需要将数据库表的行和列转换为称为 **特征** 的数值向量或矩阵。以最大化训练模型性能的方式执行这种转换的过程称为 **特征工程**，它通常需要难以用 SQL 表达的自定义代码。
- 获取文本数据（例如，产品评论）并使用自然语言处理技术尝试从中提取结构化信息（例如，作者的情感或他们提到的主题）。同样，他们可能需要使用计算机视觉技术从照片中提取结构化信息。

尽管已经有人在努力将机器学习算子添加到 SQL 数据模型并在关系基础上构建高效的机器学习系统，但许多数据科学家不喜欢在数据仓库等关系数据库中工作。相反，许多人更喜欢使用 Python 数据分析库（如 pandas 和 scikit-learn）、统计分析语言（如 R）和分布式分析框架（如 Spark）。



解决这个问题的方案是**数据湖**：一个集中的数据存储库，保存任何可能对分析有用的数据副本，通过 ETL 过程从事务型系统获得。

与数据仓库的区别在于，**数据湖只是包含文件，而不强制任何特定的文件格式或数据模型**。数据湖中的文件可能是数据库记录的集合，使用 Avro 或 Parquet 等文件格式编码，但它们同样可以包含文本、图像、视频、传感器读数、稀疏矩阵、特征向量、基因组序列或任何其他类型的数据。

除了更灵活之外，这通常也比关系数据存储更便宜，因为数据湖可以使用商品化的文件存储，如对象存储。



ETL 过程已经泛化为 **数据管道**，在某些情况下，数据湖已成为从事务型系统到数据仓库路径上的中间站。数据湖包含事务型系统产生的“原始”形式的数据，没有转换为关系数据仓库模式。这种方法的优势在于，每个数据消费者都可以将原始数据转换为最适合其需求的形式。



除了从数据湖加载数据到单独的数据仓库之外，还可以直接在数据湖中的文件上运行典型的数据仓库的功能（SQL 查询和业务分析），以及数据科学和机器学习的功能。这种架构被称为 **数据湖仓**，它需要一个查询执行引擎和一个元数据（例如，模式管理）层来扩展数据湖的文件存储。

Apache Hive、Spark SQL、Presto 和 Trino 是这种方法的例子。

### 超越数据湖

随着分析实践的成熟，组织越来越关注分析系统和数据管道的管理和运维，其中一部分是治理、隐私和遵守 GDPR 和 CCPA 等法规的问题。